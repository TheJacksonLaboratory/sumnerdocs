<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="Documentation about HPC Sumner"><link href=https://sumner.verhaaklab.com/conda/S02_gpu_config/ rel=canonical><meta name=author content="Samir B. Amin"><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-\.]+><link rel="shortcut icon" href=/assets/images/favicon/apple-icon-180x180.png><meta name=generator content="mkdocs-1.1, mkdocs-material-4.4.0"><title>GPU configuration</title><link rel=stylesheet href=../../assets/stylesheets/application.4031d38b.css><link rel=stylesheet href=../../assets/stylesheets/application-palette.224b79ff.css><meta name=theme-color content=#2196f3><script src=../../assets/javascripts/modernizr.74668098.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans:300,400,400i,700|Fira+Code&display=fallback"><style>body,input{font-family:"IBM Plex Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Fira Code","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../assets/fonts/material-icons.css><link rel=stylesheet href=../../assets/css/katex.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-64053990-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-64053990-1');
</script><meta content=https://sumner.verhaaklab.com/conda/S02_gpu_config/ property=og:url><meta property=og:title content="GPU configuration"><meta property=og:description content="Documentation about HPC Sumner"><meta property=og:image content=https://sumner.verhaaklab.com/assets/images/favicon/apple-icon-180x180.png><meta property=og:image:alt content="Image alt"><meta property=og:image:type content=image/jpeg><meta property=og:image:width content=300><meta property=og:image:height content=300><meta name=twitter:card content=summary><meta name=twitter:site content=@jacksonlab><meta name=twitter:creator content=@jacksonlab><meta property=twitter:title content="GPU configuration"><meta name=twitter:description content="Documentation about HPC Sumner"><meta name=twitter:image content=https://sumner.verhaaklab.com/assets/images/favicon/apple-icon-180x180.png><meta name=twitter:image:alt content="Image alt"></head> <body dir=ltr data-md-color-primary=blue data-md-color-accent=blue> <svg class=md-svg> <defs> <!-- <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> --> <svg xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink version=1.1 style=width:0;height:0;position:absolute;overflow:hidden;> <defs> <symbol viewbox="0 0 1024 998" aria-labelledby=dpsi-ant-github-title id=__github><title id=dpsi-ant-github-title>icon github</title><path fill=currentColor d="M0 512q0 166 95.5 298.5T343 996q6 1 10 1t6.5-1.5 4-3 2-5 .5-4.5V882q-37 4-66-.5t-45.5-14-29-23.5-17-25.5-9-24T194 780q-9-15-27-27.5t-27-20-2-14.5q50-26 113 66 34 51 119 30 10-41 40-70-116-21-172-86t-56-158q0-87 55-151-22-65 6-137 29-2 65 11.5t50.5 23T384 264q57-16 128.5-16T642 264q13-9 29-19t49-21.5 61-9.5q27 71 6 135 56 64 56 152 0 92-56.5 157.5T615 744q43 43 43 104v129q0 1 1 3 0 6 .5 9t4.5 6 11 3q154-52 251.5-185.5T1024 512q0-104-40.5-199t-109-163.5T711 40.5 512 0 313 40.5t-163.5 109T40.5 313 0 512z"/></symbol> </defs> </svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#tensorflow-v2 tabindex=1 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://sumner.verhaaklab.com title="Sumner Docs · JAX" class="md-header-nav__button md-logo"> <img src=/assets/images/sumner_logo_raw.png width=24 height=24> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Sumner Docs &middot; JAX </span> <span class=md-header-nav__topic> GPU configuration </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> Type to start searching </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/TheJacksonLaboratory/sumnerdocs/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> TheJacksonLaboratory/sumnerdocs </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <main class=md-main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://sumner.verhaaklab.com title="Sumner Docs · JAX" class="md-nav__button md-logo"> <img src=/assets/images/sumner_logo_raw.png width=48 height=48> </a> Sumner Docs &middot; JAX </label> <div class=md-nav__source> <a href=https://github.com/TheJacksonLaboratory/sumnerdocs/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> TheJacksonLaboratory/sumnerdocs </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. title=Home class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Conda Env </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Conda Env </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../S01_conda/ title=Setup class=md-nav__link> Setup </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> GPU config </label> <a href=./ title="GPU config" class="md-nav__link md-nav__link--active"> GPU config </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#tensorflow-v2 title="TensorFlow v2" class=md-nav__link> TensorFlow v2 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tensorflow-jupyter-kernel title="Tensorflow Jupyter Kernel" class=md-nav__link> Tensorflow Jupyter Kernel </a> </li> <li class=md-nav__item> <a href=#tensorboard title=Tensorboard class=md-nav__link> Tensorboard </a> </li> <li class=md-nav__item> <a href=#tensorrt title=TensorRT class=md-nav__link> TensorRT </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#pytorch title=PyTorch class=md-nav__link> PyTorch </a> </li> <li class=md-nav__item> <a href=#cupy-and-dask title="CuPy and Dask" class=md-nav__link> CuPy and Dask </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Set Up Containers </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> Set Up Containers </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../containers/S01_containers/ title="Getting Started" class=md-nav__link> Getting Started </a> </li> <li class=md-nav__item> <a href=../../containers/ensembl-vep/ title="How to run VEP using singularity" class=md-nav__link> How to run VEP using singularity </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Working with Slurm </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> Working with Slurm </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../slurm/S01_slurm101/ title="Slurm 101" class=md-nav__link> Slurm 101 </a> </li> <li class=md-nav__item> <a href=../../slurm/how_to_interactive_via_tmux/ title="Interactive job inside tmux" class=md-nav__link> Interactive job inside tmux </a> </li> <li class=md-nav__item> <a href=../../slurm/how_to_snakemake_slurm/ title="How To Run Snakemake" class=md-nav__link> How To Run Snakemake </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://hpctalk.jax.org title="User Forum (intranet)" class=md-nav__link> User Forum (intranet) </a> </li> <li class=md-nav__item> <a href=https://github.com/TheJacksonLaboratory/sumnerdocs/graphs/contributors title=Contributors class=md-nav__link> Contributors </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#tensorflow-v2 title="TensorFlow v2" class=md-nav__link> TensorFlow v2 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tensorflow-jupyter-kernel title="Tensorflow Jupyter Kernel" class=md-nav__link> Tensorflow Jupyter Kernel </a> </li> <li class=md-nav__item> <a href=#tensorboard title=Tensorboard class=md-nav__link> Tensorboard </a> </li> <li class=md-nav__item> <a href=#tensorrt title=TensorRT class=md-nav__link> TensorRT </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#pytorch title=PyTorch class=md-nav__link> PyTorch </a> </li> <li class=md-nav__item> <a href=#cupy-and-dask title="CuPy and Dask" class=md-nav__link> CuPy and Dask </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <!-- enable git edit link only if config.repo_edit is set to true --> <a href=https://github.com/TheJacksonLaboratory/sumnerdocs/edit/master/docs/conda/S02_gpu_config.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1>GPU config</h1> <h3 id=tensorflow-v2>TensorFlow v2<a class=headerlink href=#tensorflow-v2 title="Permanent link">&para;</a></h3> <ul> <li>Run interactive session on gpu compute node. GPU nodes starts with <code>hostname</code> <em>winter</em> while cpu nodes have prefix, <em>sumner</em>.</li> </ul> <div class=highlight><pre><span></span><code><span class=nb>cd</span> /fastscratch/<span class=s2>&quot;</span><span class=nv>$USER</span><span class=s2>&quot;</span>

<span class=c1>## requesting partition: gpu with gpu cores of 2</span>
srun --job-name<span class=o>=</span>tflow_gpu --partition<span class=o>=</span>gpu --qos<span class=o>=</span>batch --time<span class=o>=</span><span class=m>04</span>:00:00 --mem<span class=o>=</span>8G --nodes<span class=o>=</span><span class=m>1</span> --ntasks<span class=o>=</span><span class=m>2</span> --mail-type<span class=o>=</span>FAIL --export<span class=o>=</span>all--pty --gres gpu:2 bash --login
</code></pre></div> <ul> <li>Load GPU drivers.<ul> <li>TensorFlow requires CUDA-enabled GPU cards. <a href=https://www.tensorflow.org/install/gpu>Read detailed specifications</a> under Hardware and Software requirements.</li> </ul> </li> </ul> <div class="admonition important"> <p class=admonition-title>Ask Research IT for exact version</p> <p>GPU drivers, typically from NVIDIA are hardware-specific and not all GPU drivers may work with all hardware versions. Check with Research IT to make sure that required software are installed on gpu nodes as some may need root privileges.</p> </div> <ul> <li>Using <mark>CUDA 10.1.243</mark></li> </ul> <div class=highlight><pre><span></span><code>module load cuda10.1/toolkit/10.1.243

<span class=c1>## CUDA_HOME</span>
<span class=nb>echo</span> <span class=s2>&quot;</span><span class=nv>$CUDA_HOME</span><span class=s2>&quot;</span>

<span class=c1>## Check CUDA driver version</span>
cat <span class=s2>&quot;</span><span class=nv>$CUDA_HOME</span><span class=s2>&quot;</span>/version.txt
<span class=c1>## or</span>
nvcc --version

<span class=c1>## For cuDNN</span>
<span class=c1>## Ask Research IT if cuDNN library is not installed for a specific CUDA driver</span>
cat <span class=s2>&quot;</span><span class=nv>$CUDA_HOME</span><span class=s2>&quot;</span>/include/cudnn.h <span class=p>|</span> grep CUDNN_MAJOR -A <span class=m>2</span>

<span class=c1>## Check GPU card info: Available GPU cores, version, etc.</span>
nvidia-smi 
</code></pre></div> <blockquote> <p>/cm/shared/apps/cuda10.1/toolkit/10.1.243<br> CUDA release 10.1, V10.1.243<br> cuDNN v7.6.5.32 NVIDIA-SMI 418.87.01 | Driver Version: 418.87.01 | CUDA Version: 10.1</p> </blockquote> <ul> <li>If you do not see cuDNN SDK installed, either contact Research IT or install it by yourself. The latter option requires familiarity with Modulefiles as you may need to clone HPC module and libraries on your end, and then install cuDNN <a href=https://docs.nvidia.com/deeplearning/sdk/cudnn-archived/cudnn_741/cudnn-install/index.html#installlinux-tar>using this guide</a> or <a href=https://stackoverflow.com/a/36978616/1243763>this SO post</a>.</li> </ul> <blockquote> <p>Note that guide may be outdated for cuDNN version, and make sure that cuDNN version is aligned to CUDA driver version, i.e., 10.1, installed on gpu nodes.</p> </blockquote> <div class=highlight><pre><span></span><code><span class=nb>cd</span> ~/tmp

tar xvzf cudnn-10.1-linux-x64-v7.6.5.32.tgz

cp cuda/include/cudnn.h &lt;USER_INSTALLED_PATH&gt;/cuda/include
cp cuda/lib64/libcudnn* &lt;USER_INSTALLED_PATH&gt;/cuda/lib64
chmod a+r &lt;USER_INSTALLED_PATH&gt;/include/cudnn.h &lt;USER_INSTALLED_PATH&gt;/cuda/lib64/libcudnn*
</code></pre></div> <ul> <li>To install, <a href=https://docs.anaconda.com/anaconda/user-guide/tasks/tensorflow/ >follow official guide</a> from anaconda team.</li> </ul> <div class="admonition warning"> <p class=admonition-title>Prefer creating a dedicated env for tensorflow2 gpu</p> <ul> <li>Prefer using stable tensorflow over nightly builds.</li> <li>Prefer installing CPU vs. GPU versions in separate and new conda env.</li> <li>Avoid loading system modules for CUDA toolkit or other dependencies unless documented in installation guide above.</li> </ul> </div> <div class=highlight><pre><span></span><code><span class=c1>## By default, tf now used tf2 over tf1</span>
<span class=c1>## Using v2.1.0</span>
conda create -n tf-gpu tensorflow-gpu
conda activate tf-gpu
</code></pre></div> <ul> <li>Verify install</li> </ul> <div class="admonition tip"> <p class=admonition-title>Check GPU usage</p> <p>While running tutorials, you may run <code>watch nvidia-smi</code> in a separate tmux/screen pane to confirm that gpus and not cpus are being used for computing.</p> </div> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled checked><span class=task-list-indicator></span></label> check tensorflow version</li> </ul> <div class=highlight><pre><span></span><code>python -c <span class=s1>&#39;import tensorflow as tf; print(tf.__version__)&#39;</span>
</code></pre></div> <blockquote> <p>v2.1.0 or higher </p> </blockquote> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled checked><span class=task-list-indicator></span></label> test run</li> </ul> <div class=highlight><pre><span></span><code>python -c <span class=s2>&quot;import tensorflow as tf;print(tf.reduce_sum(tf.random.normal([1000, 1000])))&quot;</span>
</code></pre></div> <blockquote> <p>Should show <code>Tensor("Sum:0", shape=(), dtype=float32)</code>.</p> </blockquote> <ul> <li>For additional tutorials, <a href=https://www.tensorflow.org/tutorials/quickstart/beginner>checkout official guide</a>.</li> </ul> <h4 id=tensorflow-jupyter-kernel>Tensorflow Jupyter Kernel<a class=headerlink href=#tensorflow-jupyter-kernel title="Permanent link">&para;</a></h4> <ul> <li>Install <a href=https://ipython.readthedocs.io/en/stable/install/kernel_install.html>separate kernel</a> for tensorflow jupyter env.</li> </ul> <div class=highlight><pre><span></span><code>conda activate tf-gpu

conda install ipykernel
python -m ipykernel install --user --name tf-gpu --display-name <span class=s2>&quot;tf-gpu&quot;</span>
</code></pre></div> <blockquote> <p>This will install a separate python3 kernel at <em>.local/share/jupyter/kernels/tf-gpu</em>. So, when you start jupyter notebook even from a default (base) env, <code>tf-gpu</code> kernel will show up besides defauly <code>Python 3</code> kernel. However, you need to be on compatible GPU compute node to make use of <code>tf-gpu</code> kernel.</p> </blockquote> <ul> <li> <p>Load valid conda env before loading kernel</p> <ul> <li>While we have installed tf-gpu kernel, it usually loads default or base conda environment and not <em>tf-gpu</em> conda env that we created just above. This may land you into issues as PATH and other variables from base env can conflict with conda <em>tf-gpu</em> env. You can override environment prior to loading custom kernel, like tf-gpu <a href=https://github.com/jupyterhub/jupyterhub/issues/847#issuecomment-260152425>using trick from @minrk</a></li> </ul> </li> <li> <p>First make a loading script, say <code>tf-gpu-env</code> and place it somewhere outside jupyter kernel dir.</p> </li> </ul> <div class=highlight><pre><span></span><code>mkdir -p ~/bin/kernels
nano ~/bin/kernels/tf-gpu-env
</code></pre></div> <ul> <li>Edit <code>tf-gpu-env</code> to load required environment. The last command <code>exec...</code> will execute tf-gpu kernel and will inherit your custom loaded environment in jupyter notebook.</li> </ul> <div class="admonition warning"> <p class=admonition-title>environment variables in notebook</p> <p>Note that all of environment variables, including API tokens, session cookies, etc. if present in environment will be exposed to jupyter notebook. You may unset those in the script below prior to <code>exec...</code> command.</p> </div> <div class=highlight><pre><span></span><code><span class=ch>#!/bin/bash</span>

<span class=c1>## Load env before loading jupyter kernel</span>
<span class=c1>## @sbamin</span>

<span class=c1>## https://github.com/jupyterhub/jupyterhub/issues/847#issuecomment-260152425</span>

<span class=c1>#### Activate CONDA in subshell ####</span>
<span class=c1>## Read https://github.com/conda/conda/issues/7980</span>
<span class=nv>CONDA_BASE</span><span class=o>=</span><span class=k>$(</span>conda info --base<span class=k>)</span> <span class=o>&amp;&amp;</span> <span class=se>\</span>
<span class=nb>source</span> <span class=s2>&quot;</span><span class=si>${</span><span class=nv>CONDA_BASE</span><span class=si>}</span><span class=s2>&quot;</span>/etc/profile.d/conda.sh <span class=o>&amp;&amp;</span> <span class=se>\</span>
conda activate tf-gpu
<span class=c1>#### END CONDA SETUP ####</span>

<span class=c1>## Load CUDA toolkit</span>
module load s7cuda/toolkit/10.1.243

<span class=c1># this is the critical part, and should be at the end of your script:</span>
<span class=nb>exec</span> /home/amins/anaconda3/envs/tf-gpu/bin/python -m ipykernel_launcher <span class=s2>&quot;</span><span class=nv>$@</span><span class=s2>&quot;</span>

<span class=c1>## Make sure to update corresponding kernel.json under ~/.local/share/jupyter/kernels/tf-gpu/kernel.json</span>

<span class=c1>#_end_</span>
</code></pre></div> <ul> <li>Finally, backup <code>kernel.json</code> under <em>~/.local/share/jupyter/kernels/tf-gpu/</em> and replace it with following.</li> </ul> <div class=highlight><pre><span></span><code><span class=p>{</span>
 <span class=nt>&quot;argv&quot;</span><span class=p>:</span> <span class=p>[</span>
  <span class=s2>&quot;/home/amins/bin/kernels/tf-gpu-env&quot;</span><span class=p>,</span>
  <span class=s2>&quot;-f&quot;</span><span class=p>,</span>
  <span class=s2>&quot;{connection_file}&quot;</span>
 <span class=p>],</span>
 <span class=nt>&quot;display_name&quot;</span><span class=p>:</span> <span class=s2>&quot;tf-gpu&quot;</span><span class=p>,</span>
 <span class=nt>&quot;language&quot;</span><span class=p>:</span> <span class=s2>&quot;python&quot;</span>
<span class=p>}</span>
</code></pre></div> <ul> <li>Reload tf-gpu kernel in notebook and run something like <code>!env</code>. You will notice a valid tf-gpu conda env instead of default conda base environment.</li> </ul> <h4 id=tensorboard>Tensorboard<a class=headerlink href=#tensorboard title="Permanent link">&para;</a></h4> <ul> <li>Tensorboard typically comes installed with TensorFlow but conda version of tensorflow (v2.1.0) is shipping with tensorboard 2.1.1 in python 3.8 and not within the conda default python 3.7. This may create problems loading tensorboard as an extension within jupyter notebook. As an interim fix, I've reinstalled tensorboard using <code>pip</code>.</li> </ul> <details class=error><summary>Error related to opt-einsum package</summary><p>If you get following error but still have tensorboard installed, this should be harmless as long as you have valid <em>opt-einsum</em> package.</p> <div class=highlight><pre><span></span><code>ERROR: tensorflow 2.1.0 has requirement opt-einsum&gt;=2.3.2, but you&#39;ll have opt-einsum 0+untagged.56.g2664021.dirty which is incompatible.
</code></pre></div> <p>You can check using <code>conda list | grep -E "opt-einsum"</code> or using <code>pip freeze | grep -E "opt-einsum"</code>. I already had opt-einsum v3.2.1 but error was likely due to crytpic version name from conda repo.</p> </details> <div class=highlight><pre><span></span><code>conda activate tf-gpu
pip install <span class=nv>tensorboard</span><span class=o>==</span><span class=m>2</span>.1.1

python -c <span class=s1>&#39;import tensorflow as tf; print(tf.__version__)&#39;</span>
python -c <span class=s1>&#39;import tensorboard as tb; print(tb.__version__)&#39;</span>
</code></pre></div> <blockquote> <p>TensorFlow: 2.1.0<br> TensorBoard: 2.1.1 </p> </blockquote> <ul> <li><a href=https://www.tensorflow.org/tensorboard/get_started>Tensorboard: Getting started guide</a></li> </ul> <div class="admonition tip"> <p class=admonition-title>Tensorboard server over notebook extension</p> <p>Instead of using tensorboard notebook extension, prefer to run tensorboard as a standalone server, e.g.,</p> <div class=highlight><pre><span></span><code>conda activate tf-gpu <span class=o>&amp;&amp;</span> <span class=se>\</span>
<span class=nb>cd</span> &lt;workdir&gt; <span class=o>&amp;&amp;</span> <span class=se>\</span>
tensorboard serve --logdir logs --bind_all
</code></pre></div> </div> <h4 id=tensorrt>TensorRT<a class=headerlink href=#tensorrt title="Permanent link">&para;</a></h4> <ul> <li>Optional install for backward compatibility</li> <li><a href=https://docs.nvidia.com/deeplearning/sdk/tensorrt-install-guide/index.html>Visit TensorRT</a> install page for detailed guide.<ul> <li>Make sure to follow requirements given under <strong>Getting Started</strong> section, esp. PyCUDA.</li> </ul> </li> <li><a href=https://developer.nvidia.com/tensorrt>Download tarball</a> specific to CUDA and cuDNN version, e.g., CUDA 10.1 and cuDNN 7.6 as above. Accordingly, I have downloaded <em>TensorRT-6.0.1.5.CentOS-7.6.x86_64-gnu.cuda-10.1.cudnn7.6.tar.gz</em>.</li> <li> <p><a href=https://docs.nvidia.com/deeplearning/sdk/tensorrt-install-guide/index.html#installing-tar>Follow instructions for tar file</a> base installation. Know that CUDA and cuDNN versions in default instructions may be misleading and you should instead download TensorRT version based on actual CUDA and cuDNN version installed on your system.</p> </li> <li> <p>Extract tarball</p> </li> </ul> <div class=highlight><pre><span></span><code>conda activate tf-gpu

<span class=c1>## Make sure to load CUDA libs, including cuDNN libs</span>
module load s7cuda/toolkit/10.1.243

<span class=nb>cd</span> /projects/verhaak-lab/amins/sumnerenv_os7/opt/gpu/tensorRT
tar xvzf TensorRT-6.0.1.5.CentOS-7.6.x86_64-gnu.cuda-10.1.cudnn7.6.tar.gz
<span class=nb>cd</span> TensorRT-6.0.1.5 
</code></pre></div> <ul> <li>Temporarily export lib path to LD_LIBRARY_PATH.<ul> <li>After installation, lib path will rather be put in Modulefile.</li> </ul> </li> </ul> <div class=highlight><pre><span></span><code><span class=nv>LD_LIBRARY_PATH</span><span class=o>=</span><span class=s2>&quot;</span><span class=nv>$LD_LIBRARY_PATH</span><span class=s2>:</span><span class=nv>$SUM7ENV</span><span class=s2>/opt/gpu/tensorRT/TensorRT-6.0.1.5/lib&quot;</span>
<span class=nb>export</span> LD_LIBRARY_PATH
</code></pre></div> <ul> <li>Install the Python TensorRT wheel file</li> </ul> <div class=highlight><pre><span></span><code><span class=nb>cd</span> python <span class=o>&amp;&amp;</span> <span class=se>\</span>
pip install tensorrt-6.0.1.5-cp37-none-linux_x86_64.whl <span class=p>|&amp;</span> install.log
</code></pre></div> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span><code>Processing ./tensorrt-6.0.1.5-cp37-none-linux_x86_64.whl
Installing collected packages: tensorrt
Successfully installed tensorrt-6.0.1.5
</code></pre></div> </td></tr></table> <ul> <li>Install the Python UFF wheel file: Required for working with TensorFlow2</li> </ul> <div class=highlight><pre><span></span><code><span class=nb>cd</span> ../uff <span class=o>&amp;&amp;</span> <span class=se>\</span>
pip install uff-0.6.5-py2.py3-none-any.whl <span class=p>|&amp;</span> tee -a install.log <span class=o>&amp;&amp;</span> <span class=se>\</span>
<span class=nb>command</span> -v convert-to-uff
</code></pre></div> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3
4
5
6
7</pre></div></td><td class=code><div class=codehilite><pre><span></span><code>Processing ./uff-0.6.5-py2.py3-none-any.whl
Requirement already satisfied: numpy&gt;=1.11.0 in /home/amins/anaconda3/envs/tf-gpu/lib/python3.7/site-packages (from uff==0.6.5) (1.18.1)
Requirement already satisfied: protobuf&gt;=3.3.0 in /home/amins/anaconda3/envs/tf-gpu/lib/python3.7/site-packages (from uff==0.6.5) (3.11.4)
Requirement already satisfied: six&gt;=1.9 in /home/amins/anaconda3/envs/tf-gpu/lib/python3.7/site-packages (from protobuf&gt;=3.3.0-&gt;uff==0.6.5) (1.14.0)
Requirement already satisfied: setuptools in /home/amins/anaconda3/envs/tf-gpu/lib/python3.7/site-packages (from protobuf&gt;=3.3.0-&gt;uff==0.6.5) (46.1.3.post20200325)
Installing collected packages: uff
Successfully installed uff-0.6.5
</code></pre></div> </td></tr></table> <ul> <li>Install the Python graphsurgeon wheel file</li> </ul> <div class=highlight><pre><span></span><code>cd ../graphsurgeon &amp;&amp; \
pip install graphsurgeon-0.4.1-py2.py3-none-any.whl |&amp; tee -a install.log
</code></pre></div> <table class=codehilitetable><tr><td class=linenos><div class=linenodiv><pre>1
2
3</pre></div></td><td class=code><div class=codehilite><pre><span></span><code>Processing ./graphsurgeon-0.4.1-py2.py3-none-any.whl
Installing collected packages: graphsurgeon
Successfully installed graphsurgeon-0.4.1
</code></pre></div> </td></tr></table> <ul> <li>Test compilation and <a href=https://github.com/NVIDIA/TensorRT/tree/master/samples/opensource/sampleMNIST>Hello Word example</a></li> </ul> <div class=highlight><pre><span></span><code><span class=nb>cd</span> ../samples/sampleMNIST <span class=o>&amp;&amp;</span> <span class=se>\</span>
make <span class=o>&amp;&amp;</span> <span class=se>\</span>
<span class=nb>cd</span> ../../data/mnist <span class=o>&amp;&amp;</span> <span class=se>\</span>
<span class=c1>## Download MNIST dataset</span>
wget http://yann.lecun.com/exdb/mnist/train-images-idx3-ubyte.gz <span class=o>&amp;&amp;</span> <span class=se>\</span>
wget http://yann.lecun.com/exdb/mnist/train-labels-idx1-ubyte.gz <span class=o>&amp;&amp;</span> <span class=se>\</span>
wget http://yann.lecun.com/exdb/mnist/t10k-images-idx3-ubyte.gz <span class=o>&amp;&amp;</span> <span class=se>\</span>
wget http://yann.lecun.com/exdb/mnist/t10k-labels-idx1-ubyte.gz <span class=o>&amp;&amp;</span> <span class=se>\</span>

ls *ubyte.gz <span class=p>|</span> parallel -j2 gunzip <span class=o>{}</span> 

./generate_pgms.py <span class=o>&amp;&amp;</span> <span class=se>\</span>
<span class=nb>cd</span> ../.. <span class=o>&amp;&amp;</span> <span class=se>\</span>
./bin/sample_mnist -h <span class=o>&amp;&amp;</span> <span class=se>\</span>
./bin/sample_mnist --datadir<span class=o>=</span>data/mnist
</code></pre></div> <blockquote> <p>Output shows predicted probability of ASCII formatted input number. </p> </blockquote> <ul> <li>After successful install, update Modulefile, <strong>s7cuda/toolkit/10.1.243</strong> by adding TensorRT env configs.</li> </ul> <div class=highlight><pre><span></span><code><span class=c># TensorRT</span>
<span class=k>set</span>               tenrthome          <span class=o>/</span>projects<span class=o>/</span>verhaak-lab<span class=o>/</span>amins<span class=o>/</span>sumnerenv_os7<span class=o>/</span>opt<span class=o>/</span>gpu<span class=o>/</span>tensorRT<span class=o>/</span>TensorRT-6.0.1.5
<span class=nv>setenv</span>            TENSORRT_HOME       <span class=nv>$tenrthome</span>
<span class=nb>append</span><span class=o>-</span>path       LD_LIBRARY_PATH     <span class=nv>$tenrthome</span><span class=o>/</span>lib
<span class=nb>append</span><span class=o>-</span>path       PATH                <span class=nv>$tenrthome</span><span class=o>/</span>bin
</code></pre></div> <ul> <li>Restart terminal and test again</li> </ul> <div class=highlight><pre><span></span><code>conda activate tf-gpu <span class=o>&amp;&amp;</span> <span class=se>\</span>
module load s7cuda/toolkit/10.1.243 <span class=o>&amp;&amp;</span> <span class=se>\</span>
<span class=c1>## sample_mnist will be in PATH</span>
sample_mnist --datadir<span class=o>=</span><span class=s2>&quot;</span><span class=nv>$TENSORRT_HOME</span><span class=s2>&quot;</span>/data/mnist
</code></pre></div> <h3 id=pytorch>PyTorch<a class=headerlink href=#pytorch title="Permanent link">&para;</a></h3> <ul> <li>Using PyTorch stable build v1.5 for CUDA 10.1, and installing <em>pytorch-1.4.0-py3.7_cuda10.1.243_cudnn7.6.3_0</em> conda package along with dependencies.</li> </ul> <div class="admonition important"> <p class=admonition-title>Using conda installed CUDA toolkit</p> <p>Unlike tensorflow installation which depends on <em>module load cuda10.1/toolkit/10.1.243</em>, PyTorch installation will also install CUDA toolkit v10.1. Note that toolkit version must be compatible with GPU card driver, i.e., toolkit v10.1 is compatible with GPU card driver Version: 418.87.01. You can check driver and toolkit compatibility from <a href=https://www.nvidia.com/Download/index.aspx>NVIDIA Drivers Download</a> page.</p> </div> <div class=highlight><pre><span></span><code>conda activate tf-gpu

<span class=c1>## I&#39;d installed matplotlib for other purpose prior to installing pytorch</span>
conda activate matplotlib

<span class=c1>## Get updated install cmd from https://pytorch.org</span>
conda install pytorch torchvision <span class=nv>cudatoolkit</span><span class=o>=</span><span class=m>10</span>.1 -c pytorch
</code></pre></div> <ul> <li>Verify installation</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>__future__</span> <span class=kn>import</span> <span class=n>print_function</span>
<span class=kn>import</span> <span class=nn>torch</span>
<span class=n>x</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>rand</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</code></pre></div> <blockquote> <p>Above will output a tensor of 5x3 dimensions.</p> </blockquote> <h3 id=cupy-and-dask>CuPy and Dask<a class=headerlink href=#cupy-and-dask title="Permanent link">&para;</a></h3> <ul> <li><a href=https://cupy.chainer.org>CuPy</a>: A NumPy-compatible matrix library accelerated by CUDA.</li> <li><a href=https://docs.dask.org/en/latest/install.html>Dask</a></li> </ul> <div class=highlight><pre><span></span><code>conda activate tf-gpu <span class=o>&amp;&amp;</span> <span class=se>\</span>
conda install -c conda-forge cupy dask dask-ml
</code></pre></div> <ul> <li>Test CuPy</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>cupy</span> <span class=k>as</span> <span class=nn>cp</span>
<span class=n>x</span> <span class=o>=</span> <span class=n>cp</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=s1>&#39;f&#39;</span><span class=p>)</span>
<span class=n>x</span>

<span class=n>x</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</code></pre></div> <ul> <li>Test Dask, more at <a href=https://dask.org>https://dask.org</a></li> </ul> <div class=highlight><pre><span></span><code><span class=c1># Arrays implement the Numpy API</span>
<span class=kn>import</span> <span class=nn>dask.array</span> <span class=k>as</span> <span class=nn>da</span>
<span class=n>x</span> <span class=o>=</span> <span class=n>da</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>random</span><span class=p>(</span><span class=n>size</span><span class=o>=</span><span class=p>(</span><span class=mi>10000</span><span class=p>,</span> <span class=mi>10000</span><span class=p>),</span>
                     <span class=n>chunks</span><span class=o>=</span><span class=p>(</span><span class=mi>1000</span><span class=p>,</span> <span class=mi>1000</span><span class=p>))</span>
<span class=n>x</span> <span class=o>+</span> <span class=n>x</span><span class=o>.</span><span class=n>T</span> <span class=o>-</span> <span class=n>x</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</code></pre></div> <p>Last updated: May 6, 2020</p> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../S01_conda/ title=Setup class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Previous </span> Setup </span> </div> </a> <a href=../../containers/S01_containers/ title="Getting Started" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Next </span> Getting Started </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; <a href=https://www.jax.org>The Jackson Laboratory</a> | <a href=https://www.jax.org/terms-of-use>Terms of Use</a> </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> | <a href=https://github.com/sbamin/theme-mkdocs-material/ > Forked Code</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../assets/fonts/font-awesome.css> <a href=https://hpctalk.jax.org class="md-footer-social__link fa fa-envelope"></a> <a href=https://twitter.com/jacksonlab class="md-footer-social__link fa fa-twitter"></a> <a href=https://github.com/TheJacksonLaboratory/sumnerdocs class="md-footer-social__link fa fa-github"></a> </div> </div> </div> </footer> </div> <script src=../../assets/javascripts/application.ffb616e8.js></script> <script>app.initialize({version:"1.1",url:{base:"../.."}})</script> <script src=../../assets/js/katex.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script> <script src=../../search/main.js></script> </body> </html>